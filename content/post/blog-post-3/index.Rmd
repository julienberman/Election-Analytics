---
title: 'Blog Post 3: Polling'
author: Package Build
date: '2024-09-18'
slug: blog-post-3-polling
categories: []
tags: []
---
```{r}
# Load libraries.
## install via `install.packages("name")`
library(ggplot2)
library(maps)
library(tidyverse)
library(usmap)
library(plotly)
library(gridExtra)
library(sf)
library(ggrepel)
library(shiny)
library(leaflet)
library(stargazer)
library(blogdown)
library(car)
library(lubridate)
library(zoo)
library(modelsummary)
library(GGally)
library(readxl)
setwd("~/Documents/0 - Election Analytics/")
df <- read_csv("data/merged_v3.csv")
df_econ <- read_csv("data/econ_fundamentals.csv")
```
```{r}
rate_aggregation <- function(data, indicator, t1, t2) {
  subset <- data %>%
    filter(month_index >= t1 & month_index <= t2) %>%
    group_by(election_cycle) %>% 
    summarize(
      year = mean(election_year),
      value_t1 = first(.data[[indicator]][month_index == t1]),
      value_t2 = first(.data[[indicator]][month_index == t2]),
      # Dynamic naming of the aggregated variable
      !!paste0(indicator, "_agg") := (value_t2 - value_t1) / value_t1 * 100
    )
  return(subset %>% select(-value_t1, -value_t2, -election_cycle))
}
aggregate_indicators <- function(df_full, df_fundamentals, indicators, period_start, period_end, aggregation_method) {
  agg_results <- map(indicators, ~aggregation_method(df_fundamentals, .x, period_start, period_end))
  combined_agg <- reduce(agg_results, full_join, by = "year") %>% 
    mutate(across(ends_with("_agg"), ~as.numeric(scale(.))))
  df_full_merged <- df_full %>%
    left_join(combined_agg, by = "year") %>%
  return(df_full_merged)
}
```


```{r}

# merge economic indicators
indicators <- c("jobs", "pce", "rdpi", "cpi", "ics", "sp500", "unemp")
period_start <- -30
period_end <- -8 #if want 2024, can't set this super close

df <- aggregate_indicators(df, df_econ, indicators, period_start, period_end, rate_aggregation)
```


```{r}

# leave-one-out cross validation
loocv <- function(df, formula) {
  years <- unique(df$year)
  predictions_out <- numeric(length(years))
  
  for (i in seq_along(years)) {
    year <- years[i]
    # Create training data by excluding all rows from the current year
    train_data <- df %>% filter(year != !!year)
    test_data <- df %>% filter(year == !!year)
    
    # Fit the model on the training data
    model <- lm(formula, data = train_data)
    
    # Predict for the left-out year
    prediction <- predict(model, newdata = test_data)
    predictions_out[i] <- prediction
  }

  # Extract the response variable(s) from the formula
  response_vars <- as.character(formula.tools::lhs(formula))
  
  # Function to evaluate the response
  eval_response <- function(data) {
    eval(parse(text = response_vars), data)
  }

  # Calculate the MSE of out-of-sample fit 
  actuals <- eval_response(df)
  mse_out <- mean((predictions_out - actuals)^2)
  
  # Calculate the MSE of the in-sample fit
  model_in <- lm(formula, data = df)
  predictions_in <- predict(model_in)
  mse_in <- mean((actuals - predictions_in)^2)
  
  return(list(mse_out = mse_out, mse_in = mse_in))
}

formula <- 
error <- result <- loocv_mse(df, formula)

print(paste("Out-of-sample MSE:", error$mse_out))
print(paste("In-sample MSE:", error$mse_in))

```










